---
title: "U.S. Election Project"
author: "Arthur, Moritz, San Hong"
date: "2024-09-10"
output: html_document
---

# Tasks To-Do

-    Nice graph about voter turn out rate over time (?)

-   

```{r setup, include = TRUE}

library(here)
library(tidyverse)
library(plm)
library(stargazer)
library(readxl)
library(stringi)

### Change directory here. Keep file structure same as sharepoint structure.
knitr::opts_knit$set(root.dir = here::here())

```

# Preparing Data for Merge
```{r df_turnout}

### Clean workspace
rm(list=ls())

### Import voter turnout data
### https://election.lab.ufl.edu/dataset/1980-2022-general-election-turnout-rates/ 
df_turnout <- read_csv("02. Inputs/Turnout_1980_2022_v1.0.csv")

### Preparing dataframe for merging
df1 <- df_turnout %>% 
  # Changing percent string to numeric
  mutate(across(c(NONCITIZEN_PCT, VEP_TURNOUT_RATE, VAP_TURNOUT_RATE), ~as.numeric(sub("%", "", .)))) %>%
  # Removing columns unrelated to voter turnout rate
  select(1:3, VEP_TURNOUT_RATE, VAP_TURNOUT_RATE) %>% 
  # Renaming column names to lowercase (for easier merge)
  rename_all(tolower)

```

```{r df_candivote}

### Import "votes for each presidential candidate"
### https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/VOQCHQ
df_candivote <- read_csv("02. Inputs/countypres_2000-2020.csv")

### Preparing dataframe for merging
df2_1 <- df_candivote %>% 
  # Only considering Democrat, Republican, and Other (ignoring Green, Libertarian, etc)
  mutate(party_n = case_when(party == "DEMOCRAT" ~ "Democrat",
                             party == "REPUBLICAN" ~ "Republican",
                             TRUE ~ "Other")) %>% 
  group_by(year, state, county_name, office, party_n) %>% 
  summarize(county_partyvotes = sum(candidatevotes),
            .groups = "drop") %>% 
  # Changing state and county names from all caps to sentence caps
  mutate_at(c("state", "county_name"), ~str_to_sentence(.)) %>% 
  # Redundancy check, narrowing to only U.S. Presidential elections
  filter(office == "US PRESIDENT") %>% 
  select(-office) %>% 
  # Find county level total votes
  group_by(year, state, county_name) %>% 
  mutate(county_totalvotes = sum(county_partyvotes)) %>% 
  # Pivot to wide data format
  mutate(party = paste0(party_n,"_county_vote")) %>% 
  select(-party_n) %>% 
  pivot_wider(names_from = party,
              values_from = county_partyvotes) %>% 
  # Reorder variables
  relocate(Republican_county_vote, .after = Democrat_county_vote) %>% 
  relocate(county_totalvotes, .after = Other_county_vote) %>% 
  # Renaming column names to lowercase (for easier merge)
  rename_all(tolower) %>% 
  # Getting state level totals
  group_by(year, state) %>% 
  mutate(state_totalvotes = sum(county_totalvotes))

# Extracting state abbreviations
df2_2 <- df_candivote %>% 
  select(state, state_po) %>% 
  mutate(state = str_to_sentence(state)) %>% 
  rename(state_abv = state_po) %>% 
  group_by(state) %>% 
  unique()

### Merging back state abbreviations
df2 <- left_join(df2_1, df2_2, by = "state") %>% 
  relocate(state_abv, .after = state)

```

```{r df_crime}

### Import state crime rate
### https://corgis-edu.github.io/corgis/csv/state_crime/
df_crime <- read_csv("02. Inputs/state_crime.csv")

### Preparing dataframe for merging
df3 <- df_crime %>% 
  # Renaming column names to lowercase (for easier merge)
  rename_all(tolower) %>% 
  # Renaming column names to "crime" for easier indexing
  rename_with(~ gsub("data","statecrime",.), contains("data")) %>% 
  # Merging state abbreviations
  mutate(state = str_to_sentence(state)) %>% 
  left_join(df2_2, by = "state") %>% 
  relocate(state_abv, .after = state)

```

```{r df_unemployment, results='hide'}
### Import county unemployment rate
### https://www.bls.gov/lau/tables.htm#cntyaa

### Row Binding all Annual County Unemployment Data from 1997 to 2003

# Prepare Files' Paths
unemp_county_files <- list.files(path = "02. Inputs/county_unemployment", full.names = TRUE, recursive = TRUE)

# Prepare empty data frame to catch
df_unemp <- data.frame(matrix(ncol = 8, nrow = 0))

# Loop each file into binding
for (file in unemp_county_files) {
  # Read xslx file
  file_data <- read_xlsx(file)
  # Remove headers and unnecessary columns to match to empty data frame
  file_slice <- file_data[-c(1:5),-c(1,6)] %>% 
    # Remove NA (Note: there are data entry of "N.A." in character)
    na.omit()
  # Rename columns
  names(file_slice) <- c("state_code",
                         "county_code",
                         "countyName_StateAbbreviation",
                         "year",
                         "laborForce",
                         "employed",
                         "unemployed",
                         "unemploymentRate")
  # Rbind
  df_unemp <- rbind(df_unemp, file_slice)
}

### Preparing data frame for merging
df4 <- df_unemp %>% 
  # Split the state abbreviation into a separate column and make exception of District of Columbia
  group_by(state_code) %>% 
  mutate(state_abv = ifelse(grepl(",\\s([A-Z]{2})", countyName_StateAbbreviation), unlist(strsplit(countyName_StateAbbreviation, ", "))[2], "DC")) %>% 
  ungroup() %>% 
  # Split the county name into a separate column
  group_by(county_code) %>% 
  mutate(county_name = unlist(strsplit(countyName_StateAbbreviation, ", "))[1])


```

# Merging Data
```{r merge}

### Merge dataframes
# Df2 is primary, because it has county level and state level
df_merge <- df2 %>% 
  left_join(df1 %>%  select(-state), by = join_by("year" == "year", "state_abv" == "state_abv")) %>%  
  left_join(df3 %>% select(-state), by = join_by("year" == "year", "state_abv" == "state_abv")) %>% 
  mutate(idkey = paste0(state_abv,"_", county_name)) %>% 
  relocate(idkey, .before = 1)

### Save dataset
write.csv(df_merge, file = paste0("04. Outputs/", today(), "_electiondataset.csv"))

```

# Analysis Section
```{r quick-regression}

p.df <- df_merge %>% 
  pdata.frame(index = c("idkey", "year"))

plm(democrat_county_vote~vep_turnout_rate,
    data = p.df,
    effect = "twoway", model = "within") %>% 
  stargazer(
          type = ifelse(knitr::is_latex_output(),"latex", "text"),
          report = "vc*sp",
          # dep.var.labels = paste0(title),
          dep.var.labels.include = T,
          column.sep.width = "0pt",
          float = FALSE,
          header = FALSE,
          no.space = TRUE,
          font.size = "small"
          )

plm(republican_county_vote~vep_turnout_rate,
    data = p.df,
    effect = "twoway", model = "within") %>% 
  stargazer(
          type = ifelse(knitr::is_latex_output(),"latex", "text"),
          report = "vc*sp",
          # dep.var.labels = paste0(title),
          dep.var.labels.include = T,
          column.sep.width = "0pt",
          float = FALSE,
          header = FALSE,
          no.space = TRUE,
          font.size = "small"
          )

```

# Visualization Section
```{r viz}

```

