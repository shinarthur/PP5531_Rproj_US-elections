---
title: "U.S. Election Project | Visualization"
author: "Arthur, Moritz, San Hong"
date: "2024-11-01"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

# Setup
Loading packages and setting working directly. Note that working directory is set by the `here::here()` command and does not need to be edited, so long as file structure is maintained.
```{r setup, message=FALSE, warning=FALSE}

# basic R packages
library(here)
library(tidyverse)
library(readr)
library(dplyr)

# ggplot packages
library(ggplot2)
library(RColorBrewer)
library(ggthemes)
library(hrbrthemes)
library(viridis)
library(showtext)
library(ggpmisc)
sysfonts::font_add_google("Roboto Condensed")
showtext_auto()

# geospatial packages
library(maps)
library(usmap)

# regression / coefplot packages
library(plm)
library(broom)
library(corrplot)
library(dotwhisker)
library(did)

### Change directory here. 
### As long as file structure is same as github structure, directory does not need to be changed.
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)

```

# Import Data
Importing data necessary to create visualizations.
```{r import data}
rm(list=ls())

### Import election dataset
df <- read_rds("04. Outputs/2024-10-26_electiondataset.rds")

legend <- df %>% 
  colnames() %>% 
  as.data.frame()

### Import factiva search data
IMPORT.factiva <- read.csv("04. Outputs/FactivaGerrymandering.csv", header = FALSE, stringsAsFactors = FALSE)

df_factiva <- IMPORT.factiva %>%
  filter(grepl("Start Date", V1)) %>%
  mutate(Year = as.numeric(gsub(".*(\\d{4}).*", "\\1", V1)),  # Extract the start year
         Document_Count = as.numeric(V2)) %>% # Convert document count to numeric %>% 
  filter(!is.na(Year), !is.na(Document_Count)) # Remove rows with missing data (if any)

### Import regression p dataframe
p.df <- read_rds("04. Outputs/2024-10-26_regressionDF.rds")
  
```

# Formatting Presets
Custom presets for ggplot elements and custom function to save ggplots in a consistent manner.
```{r custom presets & function}

format <- theme_ipsum_rc(base_size = 30)+
      theme(plot.title = element_text(size = 50, lineheight = 0.55),
        plot.subtitle = element_text(size = 30, color = "#939198"),
        axis.title.x = element_text(size = 30, hjust = 0.5),
        axis.title.y = element_text(size = 30, hjust = 0.5),
        axis.text = element_text(lineheight = 0.55),
        legend.position = "none",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        plot.caption = element_text(size = 30, hjust=0)
        # axis.text.x = element_blank(),
        # panel.background = element_blank()
        )

format2 <- theme_ipsum_rc(base_size = 30)+
      theme(plot.title = element_text(size = 50, lineheight = 0.55, hjust = 0.5),
        plot.subtitle = element_text(size = 30, color = "#939198", hjust = 0.5),
        axis.title.x = element_text(size = 30, hjust = 0.5),
        axis.title.y = element_text(size = 30, hjust = 0.5),
        axis.text = element_text(lineheight = 0.55),
        plot.caption = element_text(size = 30, hjust=0),
        legend.title = element_blank()
        )

f.ggsave <- function(name = "asdf", width.sav = 16, height.sav = 9, dpi.sav = 150, output.type = "png"){
  filepath <- paste0("05. Visualizations/", name, "_", today(), ".", output.type)
  ggsave(filepath, width = width.sav, height = height.sav, units = "in", dpi = dpi.sav)
  # print(filepath)
}

f.tidy.reg <- function(dv.sav = dv, iv.sav = iv, ctrl.sav = ctrl,
                        dataframe.sav = p.df, 
                        effect.sav = "twoways",
                        model.sav = "within"){
  formula_str <- paste0(dv.sav, "~", iv.sav, "+", ctrl.sav)
  out <- plm(as.formula(paste(formula_str, collapse = " ")),
             data = dataframe.sav, effect = effect.sav, model = model.sav)
  tidyout.coef <- tidy(out, conf.int = TRUE, conf.level = 0.9)
  tidyout.fitted <- fitted(out)
  tidyout.resid <- resid(out)
  tidyout <- list(tidyout.coef, tidyout.fitted, tidyout.resid)
  return(tidyout)
}

```


# Background Visualization
Data visualizations to help establish the context.

## Factiva Search
Trends in articles mentioning 'gerrymandering'.
```{r factiva viz}

# Create the bar chart with the YlOrRd color palette
df_factiva %>% 
  ggplot(aes(x = Year, y = Document_Count)) +
  geom_bar(stat = "identity", fill = brewer.pal(9, "YlOrRd")[5]) +  # Use a specific shade from YlOrRd
  labs(title = "Trend in Articles Mentioning 'Gerrymandering'", 
       x = "\nYear", 
       y = "Number of Articles\n",
       subtitle = "Source: Factiva search") +
  scale_y_continuous(labels = scales::comma_format()) +
  format

# Save visualization
f.ggsave(name = "FactivaViz",
         width.sav = 12,
         height.sav = 8,
         output.type = "jpg")

```

## Geospatial
Map of the type of court involvement in state redistricting during the 2012 election cycle per state.
```{r geospatial viz}

### Preparing data
# Filter data for 2012 and ensure state_abv is character type
df_2012 <- df %>%
  filter(year == 2012) %>%
  mutate(state_abv = as.character(state_abv)) %>%
  select(state_abv, court_action_none_count_VAR, 
         court_map_drawn_count_VAR, court_return_leg_count_VAR, 
         court_challenge_rejected_count_VAR)

# Create a new column that categorizes states based on court action
df_2012 <- df_2012 %>%
  mutate(court_combined_VAR = case_when(
    court_challenge_rejected_count_VAR > 0 ~ "Court finding: Constitutional map  ",
    court_return_leg_count_VAR > 0 ~ "Court finding: Unconstitutional map  ",
    court_map_drawn_count_VAR > 0 ~ "Court finding: Unconstitutional map  ",
    court_action_none_count_VAR > 0 ~ "Redistricting with no court involvement  ",
    TRUE ~ "No redistricting  "
  )) %>% 
  mutate(court_combined_VAR = factor(court_combined_VAR, 
                                     levels = c("No redistricting  ", 
                                               "Redistricting with no court involvement  ",
                                               "Court finding: Constitutional map  ",
                                               "Court finding: Unconstitutional map  "
                                               )))


# Map state abbreviations to full state names for usmap
state_abbreviations <- data.frame(
  state_abv = c(state.abb, "DC"),
  state = c(state.name, "District of Columbia")
)

# Join the full state names to the data
df_2012 <- df_2012 %>%
  left_join(state_abbreviations, by = "state_abv")


### Define a color palette using RColorBrewer (YlOrRd)
color_palette <- brewer.pal(n = 5, name = "YlOrRd")
category_colors <- c("Court finding: Unconstitutional map  " = color_palette[5],  # Deep Red
                     # "Returned to Legislature" = color_palette[4],  # Orange-Red
                     "Court finding: Constitutional map  " = color_palette[3],  # Orange
                     "Redistricting with no court involvement  " = color_palette[2],  # Light Orange-Yellow
                     "No redistricting  " = "white")  # White for None

category_colors <- c("Court finding: Unconstitutional map  " = "#FF687F",
                     "Court finding: Constitutional map  " = "#005E8A",
                     "Redistricting with no court involvement  " = "#FFB188",
                     "No redistricting  " = "#D3D4D6")

### Plot using usmap (now with full state names)
plot_usmap(data = df_2012, values = "court_combined_VAR", regions = "states"
           , color = "white") +
  scale_fill_manual(values = category_colors, name = "Type of Court Action") +
  labs(title = "\nTypes of Court Involvement in State Redistricting \nDuring the 2012 Election Cycle",
       subtitle = "\n" ) +
  theme(legend.position = "top",  # Move the legend to the bottom
        plot.title = element_text(hjust = 0.5, size = 50, family = "Roboto Condensed", face = "bold", lineheight = 0.55),  # Center the title
        # legend.title = element_text(size = 12, family = "Roboto Condensed", face = "bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = 20, family = "Roboto Condensed"),
        legend.key.size = unit(0.5, "cm"))
  # guides(fill = guide_legend(
  #   title.position = "top",  # Place the legend title above the categories
  #   title.hjust = 0.5,  # Center the legend title
  #   nrow = 1  # Place categories in a single row
  # ))

# Save visualization
f.ggsave(name = "MapViz", width.sav = 12, height.sav = 8, 
         output.type = "jpg")

```

A bargraph version to better portray the number of states per action.
```{r bargraph_map}

df_2012 %>% 
  ggplot(aes(x = court_combined_VAR, fill = court_combined_VAR))+
  geom_bar(width = 0.7)+
  scale_fill_manual(values = category_colors, name = "Type of Court Action")+
  labs(title = "Count of the Types of Court Involvement \nDuring the 2012 Election Cycle", 
       x = "",
       y = "Number of States\n"
       ) +
  coord_flip()+
  format

# Save visualization
f.ggsave(name = "MapVizBar", width.sav = 20, height.sav = 9, 
         output.type = "jpg")

```

# Regression Findings Visualization

## Regression (Correlation Plot)
```{r correlation check}

turnout_rate <- p.df$vep_turnout_rate
vep_density <- p.df$vep_density
unemployment <- p.df$state_unemploymentRate
vote_closeness <- p.df$vote_closeness

pseries_df <- data.frame(turnout_rate, vep_density, unemployment, vote_closeness) %>% 
  na.omit()

cormatrix <- cor(pseries_df)

print(cormatrix)
corrplot(cormatrix, method = "circle")


```

## Regression (Coefficient Plot)
### Preparation
Creating the tidy output of the regression.
```{r prep regression coefficient}

### Setting variables
dv <- "log(vep_turnout_rate)"
ctrl <- "log(vep_density) + log(state_unemploymentRate) + stateparty_control + log(lagged_vep) + log(vote_closeness)"

### Creating Tidy Data
tidyout_NONE <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_court_action_none_count", ctrl.sav = ctrl)[[1]] %>% 
  mutate(model_desc = "No court involvement",
         model = "Model A")

tidyout_ANY <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary", ctrl.sav = ctrl)[[1]] %>% 
  mutate(model_desc = "ANY court involvement",
         model = "Model B")

tidyout_UNFAIR <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary_unfair", ctrl.sav = ctrl)[[1]] %>% 
  mutate(model_desc = "Court finding: Unconstitutional map",
         model = "Model C")

tidyout_FAIR <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary_fair", ctrl.sav = ctrl)[[1]] %>% 
  mutate(model_desc = "Court finding: Constitutional map",
         model = "Model D")

### Join tidy data
all_models <- bind_rows(tidyout_NONE, tidyout_ANY, tidyout_UNFAIR, tidyout_FAIR) %>% 
  mutate(model = factor(model, levels = c("Model A", "Model B", "Model C", "Model D")))

### Creating residual data
resid_NONE <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_court_action_none_count", ctrl.sav = ctrl)[[3]] %>% 
  as.data.frame() %>% 
  mutate(model_desc = "No court involvement",
         model = "Model A")

resid_ANY <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary", ctrl.sav = ctrl)[[3]] %>%
  as.data.frame() %>% 
  mutate(model_desc = "ANY court involvement",
         model = "Model B")

resid_UNFAIR <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary_unfair", ctrl.sav = ctrl)[[3]] %>%
  as.data.frame() %>% 
  mutate(model_desc = "Court finding: Unconstitutional map",
         model = "Model C")

resid_FAIR <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary_fair", ctrl.sav = ctrl)[[3]] %>%
  as.data.frame() %>% 
  mutate(model_desc = "Court finding: Constitutional map",
         model = "Model D")

### Join tidy data
all_resid <- bind_rows(resid_NONE, resid_ANY, resid_UNFAIR, resid_FAIR) %>% 
  mutate(model = factor(model, levels = c("Model A", "Model B", "Model C", "Model D"))) %>% 
  rename(resid = ".")

### Creating fitted data
fitted_NONE <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_court_action_none_count", ctrl.sav = ctrl)[[2]] %>% 
  as.data.frame() %>% 
  mutate(model_desc = "No court involvement",
         model = "Model A")

fitted_ANY <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary", ctrl.sav = ctrl)[[2]] %>%
  as.data.frame() %>% 
  mutate(model_desc = "ANY court involvement",
         model = "Model B")

fitted_UNFAIR <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary_unfair", ctrl.sav = ctrl)[[2]] %>%
  as.data.frame() %>% 
  mutate(model_desc = "Court finding: Unconstitutional map",
         model = "Model C")

fitted_FAIR <- f.tidy.reg(dv.sav = dv, iv.sav = "interaction_judiciary_fair", ctrl.sav = ctrl)[[2]] %>%
  as.data.frame() %>% 
  mutate(model_desc = "Court finding: Constitutional map",
         model = "Model D")

### Join tidy data
all_fitted <- bind_rows(fitted_NONE, fitted_ANY, fitted_UNFAIR, fitted_FAIR) %>% 
  mutate(model = factor(model, levels = c("Model A", "Model B", "Model C", "Model D"))) %>% 
  rename(fitted = ".")

### Merge residual and fitted data
all_resxfit <- all_resid %>% 
  cbind(fitted = all_fitted$fitted)

```

### Visualization code
Creating the coefficient plot.
```{r coeff viz}

################################################################################
### Creating Coefficient Plot (Interaction ONLY)

all_models %>% 
  filter(grepl("interaction", term)) %>%
  dwplot(model_order = c("Model A", "Model B", "Model C", "Model D"),
         ci = 0.90,
         dot_args = list(size = 3),
         whisker_args = list(size = 1.5)
         ) %>% 
  relabel_predictors(c(`interaction_court_action_none_count` = "Interaction Term (Treatment x Time):\nNo court involvement ",
                       `interaction_judiciary` = "Interaction Term (Treatment x Time):\nANY court involvement ",
                       `interaction_judiciary_unfair` = "Interaction Term (Treatment x Time):\nCourt finding - Unconstitutional map ",
                       `interaction_judiciary_fair` = "Interaction Term (Treatment x Time):\nCourt finding - Constitutional map "
                       ))+
  geom_vline(xintercept = 0,
               colour = "grey60",
               linetype = 2) +
  labs(title = "Effects on Logged Voter Turnout Rates By \nJudicial Involvements in Redistricting (90% CI)",
       subtitle = "Results from multivariate regression models using time and state fixed effects",
       x = "\nCoefficient Estimates"
       ) +
  format2+
  theme(legend.key.size = unit(2, "cm"),
        panel.border = element_rect(colour = "black", fill=NA))

# Save visualization
f.ggsave(name = "CoeffViz_Interaction",
         width.sav = 16,
         height.sav = 12,
         output.type = "jpg")


################################################################################
### Creating Coefficient Plot (some covariates)

all_models %>% 
  filter(!term %in% c("log(vep_density)", "log(state_unemploymentRate)", "log(lagged_vep)")) %>%
  dwplot(model_order = c("Model A", "Model B", "Model C", "Model D"),
         ci = 0.90,
         dot_args = list(size = 3),
         whisker_args = list(size = 1.5)
         ) %>% 
  relabel_predictors(c(`interaction_court_action_none_count` = "Interaction Term (Treatment x Time):\nNo court involvement ",
                       `interaction_judiciary` = "Interaction Term (Treatment x Time):\nANY court involvement ",
                       `interaction_judiciary_unfair` = "Interaction Term (Treatment x Time):\nCourt finding - Unconstitutional map ",
                       `interaction_judiciary_fair` = "Interaction Term (Treatment x Time):\nCourt finding - Constitutional map ",
                       `stateparty_controlDEM` = "State Legislature Control:\nDemocrats",
                       `stateparty_controlREP` = "State Legislature Control:\nRepublicans",
                       `log(vote_closeness)` = "Closeness of Votes Between Candidates\n(Logged percentage)"
                       ))+
  geom_vline(xintercept = 0,
               colour = "grey60",
               linetype = 2) +
  labs(title = "Effects on Logged Voter Turnout Rates By \nJudicial Involvements in Redistricting (90% CI)",
       subtitle = "Results from multivariate regression models using time and state fixed effects",
       x = "\nCoefficient Estimates"
       ) +
  format2+
  theme(legend.key.size = unit(2, "cm"),
        panel.border = element_rect(colour = "black", fill=NA))

# Save visualization
f.ggsave(name = "CoeffViz_partial",
         width.sav = 16,
         height.sav = 12,
         output.type = "jpg")


################################################################################
### Creating Coefficient Plot (ALL variables)

all_models %>% 
  # filter(term %in% c("log(vep_density)", "")) %>%
  dwplot(model_order = c("Model A", "Model B", "Model C", "Model D"),
         ci = 0.90,
         dot_args = list(size = 3),
         whisker_args = list(size = 1.5)
         ) %>% 
  relabel_predictors(c(`interaction_court_action_none_count` = "Interaction Term (Treatment x Time):\nNo court involvement ",
                       `interaction_judiciary` = "Interaction Term (Treatment x Time):\nANY court involvement ",
                       `interaction_judiciary_unfair` = "Interaction Term (Treatment x Time):\nCourt finding - Unconstitutional map ",
                       `interaction_judiciary_fair` = "Interaction Term (Treatment x Time):\nCourt finding - Constitutional map "
                       ))+
  geom_vline(xintercept = 0,
               colour = "grey60",
               linetype = 2) +
  labs(title = "Effects on Logged Voter Turnout Rates By \nJudicial Involvements in Redistricting (90% CI)",
       subtitle = "Results from multivariate regression models using time and state fixed effects",
       x = "\nCoefficient Estimates"
       ) +
  format2+
  theme(legend.key.size = unit(2, "cm"),
        panel.border = element_rect(colour = "black", fill=NA))

# Save visualization
f.ggsave(name = "CoeffViz_All",
         width.sav = 16,
         height.sav = 12,
         output.type = "jpg")


```

## Other Robustness Checks
Testing parallel trends assumption:
* Wald test result = 0.055
* Trend bars insignificant


```{r parallel trends}
### Testing parallel trends assumption
ptrends <- p.df %>% 
  filter(year_num == 2012 & judiciary_fair_map_VAR == 1) %>% 
  select(state_abv) %>% 
  mutate(first_treat = 2012) %>% 
  right_join(p.df, by = join_by("state_abv")) %>%
  mutate(first_treat = ifelse(is.na(first_treat), 0, first_treat)) %>% 
  mutate(vep_turn_ln = log(vep_turnout_rate),
         fips_num = as.numeric(fips))

out <- att_gt(yname = "vep_turn_ln",
              gname = "first_treat",
              idname = "fips_num",
              tname = "year_num",
              data = ptrends,
              # xformla = ~1
              # ,
              est_method = "reg")

### Wald test for p-trend
summary(out)

# Trend bars
ggdid(out)

```

```{r}
### Residual tests
ggplot(data = all_resid, aes(sample = resid)) +
  geom_qq() +
  stat_qq_line(col="red") +
  facet_wrap(vars(model)) +
  labs(title = "Q-Q Plots: Normality of Residuals for Each Model") +
  theme_minimal()

f.ggsave(name = "QQ Plots",
         width.sav = 12,
         height.sav = 8,
         output.type = "jpg")

res_test <- all_resid %>% 
  group_by(model) %>% 
  summarize(tidy(Box.test(resid, lag = 40, type = c("Box-Pierce", "Ljung-Box"))))

ggplot(data = all_resxfit, aes(x = fitted, y = resid)) +
  geom_point() +
  geom_hline(yintercept = 0) +
  facet_wrap(vars(model)) +
  labs(title = "Residual Plots: Heteroscedasticity Test for Each Model",
       x='Fitted Values', y='Residuals') +
  theme_minimal()

f.ggsave(name = "Residual Plots_H-test",
         width.sav = 12,
         height.sav = 8,
         output.type = "jpg")

ggplot(data = all_resxfit, aes(x = resid)) +
  geom_density() +
  facet_wrap(vars(model)) +
  labs(title = "Residual Plots: Density",
       x='Residuals', y = "Density") +
  theme_minimal()

f.ggsave(name = "Residual Plots_Density",
         width.sav = 12,
         height.sav = 8,
         output.type = "jpg")

### Distribution of DV
cleaned_data <- p.df %>%
  filter(!is.na(vep_turnout_rate))

cleaned_data %>% 
  as.data.frame() %>% 
  ggplot(aes(x = vep_turnout_rate))+
  geom_histogram()+
  labs(title = "Histogram of Turnout Rates",
       x = "\nVEP Turnout Rates (in %)",
       y = "Frequency\n"
       ) +
  format2

hist(p.df$vep_turnout_rate, breaks = 30, col = "#FF687F", border = "white",
     main = "Histogram of Turnout Rates",
     xlab = "VEP Turnout Rate")
```




