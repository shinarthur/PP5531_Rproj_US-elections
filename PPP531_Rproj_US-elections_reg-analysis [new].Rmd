---
title: "U.S. Election Project"
author: "Arthur, Moritz, San Hong"
date: "2024-09-10"
output: html_document
---

# Setup
```{r setup}

# install.packages("here")
# install.packages("tidyverse")
# install.packages("plm")
# install.packages("stargazer")
# install.packages("readxl")
# install.packages("labelled")
# install.packages("sjlabelled")

library(here)
library(tidyverse)
library(plm)
library(stargazer)
library(readxl)
library(labelled)
library(sjlabelled)

### Change directory here. 
### As long as file structure is same as github structure, directory does not need to be changed.
knitr::opts_knit$set(root.dir = here::here())

```


```{r import data}

### Clean environment
rm(list=ls())

### Import data created in dataset-creation.rmd
df <- read_rds("04. Outputs/2024-10-09_electiondataset.rds")

### Legend of variables (variable name x explanation of each variable)
legend_df <- sjlabelled::get_label(df) %>%
  as.data.frame() %>% 
  rownames_to_column(var = "variable") %>% 
  rename("label" = ".")

### Data without labels (if necessary)
df_nolabel <- labelled::remove_labels(df)

```


```{r data-check}

temp.variable_list <- c("court_action_none_count_VAR", "court_map_drawn_count_VAR", "court_return_leg_count_VAR", "court_challenge_rejected_count_VAR", "judiciary_VAR", "judiciary_unfair_map_VAR", "judiciary_fair_map_VAR")
temp.year_expression_list <- list(expr(year_num == 2012), expr(year_num >= 2012), expr(TRUE))

for(year.sel in temp.year_expression_list){
    print(as_label(year.sel))
    
    for(val in temp.variable_list){
    
    df %>% 
      filter(!!year.sel) %>%
      select(paste0(val)) %>% 
      table() %>% 
      print()
    
  }
}

### Cleanwork space
rm(list = grep("temp", ls(), value = TRUE))

```


# Functions
```{r custom reg function}
### Creating a function to run multiple regressions simultaneously
f.reg.multi <- function(dv.sav = dv, 
                        iv.sav = iv, 
                        dataframe.sav = p.df, 
                        title.sav = "testingasdf", 
                        effect.sav = "time",
                        type.sav = "within", 
                        dv_label.sav = NULL, 
                        cov_label.sav = NULL,
                        index.sav = NULL,
                        star.type = ifelse(knitr::is_latex_output(),"latex", "text"),
                        star.out = NULL) {
  templist <- list()
  
  for (i in 1:length(dv.sav)){
  
    val <- dv.sav[[i]]
    
    formula_str <- paste0(val, "~", iv.sav)
    
    templist[[i]] <- plm(as.formula(paste(formula_str, collapse = " ")),
                        data = dataframe.sav
                        , effect = effect.sav,
                        model = type.sav
                        , index = index.sav
                        )
  }
    
  stargazer(templist,
          type = star.type,
          out = star.out,
          report = "vc*sp",
          title = "asdf",
          dep.var.labels = paste0(title.sav),
          dep.var.labels.include = T,
          # column.sep.width = "0pt",
          float = FALSE,
          header = FALSE,
          # no.space = TRUE,
          font.size = "small",
          column.labels = dv_label.sav,
          covariate.labels = cov_label.sav
          ) %>%
    return()
  
}

f.reg.multi.iv <- function(dv.sav = dv, 
                        iv.sav = iv, 
                        ctrl.sav = ctrl,
                        dataframe.sav = p.df, 
                        title.sav = "testingasdf", 
                        effect.sav = "time",
                        type.sav = "within", 
                        dv_label.sav = NULL, 
                        cov_label.sav = NULL,
                        index.sav = NULL,
                        star.type = ifelse(knitr::is_latex_output(),"latex", "text"),
                        star.out = NULL) {
  templist <- list()
  
  for (i in 1:length(iv.sav)){
  
    val <- iv.sav[[i]]
    
    formula_str <- paste0(dv.sav, "~", val, "+", ctrl.sav)
    
    templist[[i]] <- plm(as.formula(paste(formula_str, collapse = " ")),
                        data = dataframe.sav
                        , effect = effect.sav,
                        model = type.sav
                        , index = index.sav
                        )
  }
    
  stargazer(templist,
          type = star.type,
          out = star.out,
          report = "vc*sp",
          title = "asdf",
          dep.var.labels = paste0(title.sav),
          dep.var.labels.include = T,
          # column.sep.width = "0pt",
          float = FALSE,
          header = FALSE,
          # no.space = TRUE,
          font.size = "small",
          column.labels = dv_label.sav,
          covariate.labels = cov_label.sav
          ) %>%
    return()
  
}

```


# Analysis Section

```{r did}

### Panel Data Frame for DID
p.df <- df %>% 
  filter(avg_DEMvote_perc > 0.0001 & avg_REPvote_perc > 0.0001) %>% 
  # filter(year_num >= 2004 & year_num <= 2016) %>% 
  mutate(time = case_when(year %in% c("2000", "2004", "2008") ~ 0,
                          year %in% c("2012", "2016", "2020") ~ 1)) %>% 
  mutate(stateparty_control = fct_relevel(stateparty_control, "SPLIT", "DEM", "REP")) %>% 
  mutate(interaction_judiciary = time * judiciary_VAR,
         interaction_court_action_none_count = time * court_action_none_count_VAR,
         interaction_court_map_drawn_count = time * court_map_drawn_count_VAR,
         interaction_court_return_leg_count = time * court_return_leg_count_VAR,
         interaction_court_challenge_rejected_count = time * court_challenge_rejected_count_VAR,
         interaction_judiciary_unfair = time * judiciary_unfair_map_VAR,
         interaction_judiciary_fair = time * judiciary_fair_map_VAR
         ) %>% 
  pdata.frame(index = c("state_abv", "year")) 

### Legend of variables (variable name x explanation of each variable)
legend_p.df <- sjlabelled::get_label(p.df) %>%
  as.data.frame() %>% 
  rownames_to_column(var = "variable") %>% 
  rename("label" = ".")

# Data-check for DID
table(p.df$time)
table(p.df$judiciary_VAR)
table(p.df$judiciary_VAR[p.df$time == 1])
table(p.df$judiciary_VAR[p.df$time == 0])
table(p.df$interaction_judiciary)

# Manipulate Controls here
iv_control <- "log(vep_density) + log(state_unemploymentRate) + stateparty_control + log(lagged_vep) + log(vote_closeness)"


```

```{r}
### WITH judiciary_VAR
dv <- c("avg_DEMvote_perc", "avg_REPvote_perc", "log(vep_turnout_rate)")
iv_main <- "interaction_judiciary"
iv <- paste0(iv_main, " + ", iv_control)

dv_label <- c("DEM candidate's % of county votes (log)", "REP candidate's % of county votes (log)", "Voting-Eligible-Population turnout rate (log)")
# cov_label <- c("Treatment/Control Group (1/0) - Any Judiciary Action Taken", 
#                "Time Period After/Before (1/0)",
#                "Interaction (Judicial x Time)",
#                "Voting-Eligible-Population turnout rate (log)", 
#                "Unemployment rate  (log)",
#                "GDP (log)"
#                #, "State legislature control - DEM", 
#                #"State legislature control - REP"
#                )

# Title = Effect of Redistricting on Party Choice in Presidential Elections
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "-regression-tbl-polling-did-judicial.html")
            )

# Check N & T
summary(plm(as.formula(paste0(dv[3], "~", iv)),
                        data = p.df
                        , index = c("state_abv", "year")
                        , effect = "twoway",
                        model = "within"
           ))

summary(lm(as.formula(paste0(dv[3], "~", iv)),
                      data = p.df
           ))

```

```{r}
### WITH court_map_drawn_count
dv <- c("avg_DEMvote_perc", "avg_REPvote_perc", "log(vep_turnout_rate)")
iv_main <- "interaction_court_map_drawn_count"
iv <- paste0(iv_main, " + ", iv_control)
dv_label <- c("DEM candidate's % of county votes (log)", "REP candidate's % of county votes (log)", "Voting-Eligible-Population turnout rate (log)")
# cov_label <- c("Treatment/Control Group (1/0) - Map Drawn by Court", 
#                "Time Period After/Before (1/0)",
#                "Interaction (Judicial x Time)",
#                "Voting-Eligible-Population turnout rate (log)", 
#                "Unemployment rate  (log)",
#                "GDP (log)"
#                #, "State legislature control - DEM", 
#                #"State legislature control - REP"
#                )

# Title = Effect of Redistricting on Party Choice in Presidential Elections
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "-regression-tbl-polling-did-map-draw.html")
            )

# Check N & T
summary(plm(as.formula(paste0(dv, "~", iv)),
                        data = p.df
                        , effect = "twoway",
                        model = "within"
           ))
```

```{r}
### WITH court_return_leg_count
dv <- c("avg_DEMvote_perc", "avg_REPvote_perc", "log(vep_turnout_rate)")
iv_main <- "interaction_court_return_leg_count"
iv <- paste0(iv_main, " + ", iv_control)
dv_label <- c("DEM candidate's % of county votes (log)", "REP candidate's % of county votes (log)", "Voting-Eligible-Population turnout rate (log)")
# cov_label <- c("Treatment/Control Group (1/0) - Map Drawn by Court", 
#                "Time Period After/Before (1/0)",
#                "Interaction (Judicial x Time)",
#                "Voting-Eligible-Population turnout rate (log)", 
#                "Unemployment rate  (log)",
#                "GDP (log)"
#                #, "State legislature control - DEM", 
#                #"State legislature control - REP"
#                )

# Title = Effect of Redistricting on Party Choice in Presidential Elections
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "-regression-tbl-polling-did-court-return-leg.html")
            )

# Check N & T
summary(plm(as.formula(paste0(dv, "~", iv)),
                        data = p.df
                        , effect = "twoway",
                        model = "within"
           ))
```

```{r}
### WITH court_challenge_rejected_count
dv <- c("avg_DEMvote_perc", "avg_REPvote_perc", "log(vep_turnout_rate)")
iv_main <- "interaction_court_challenge_rejected_count"
iv <- paste0(iv_main, " + ", iv_control)
dv_label <- c("DEM candidate's % of county votes (log)", "REP candidate's % of county votes (log)", "Voting-Eligible-Population turnout rate (log)")
# cov_label <- c("Treatment/Control Group (1/0) - Map Drawn by Court", 
#                "Time Period After/Before (1/0)",
#                "Interaction (Judicial x Time)",
#                "Voting-Eligible-Population turnout rate (log)", 
#                "Unemployment rate  (log)",
#                "GDP (log)"
#                #, "State legislature control - DEM", 
#                #"State legislature control - REP"
#                )

# Title = Effect of Redistricting on Party Choice in Presidential Elections
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "-regression-tbl-polling-did-court-reject.html")
            )

# Check N & T
summary(plm(as.formula(paste0(dv, "~", iv)),
                        data = p.df
                        , effect = "twoway",
                        model = "within"
           ))

```
```{r}
### WITH judicial_fair
dv <- c("avg_DEMvote_perc", "avg_REPvote_perc", "log(vep_turnout_rate)")
iv_main <- "interaction_judiciary_fair"
iv <- paste0(iv_main, " + ", iv_control)
dv_label <- c("DEM candidate's % of county votes (log)", "REP candidate's % of county votes (log)", "Voting-Eligible-Population turnout rate (log)")
# cov_label <- c("Treatment/Control Group (1/0) - Map Drawn by Court", 
#                "Time Period After/Before (1/0)",
#                "Interaction (Judicial x Time)",
#                "Voting-Eligible-Population turnout rate (log)", 
#                "Unemployment rate  (log)",
#                "GDP (log)"
#                #, "State legislature control - DEM", 
#                #"State legislature control - REP"
#                )

# Title = Effect of Redistricting on Party Choice in Presidential Elections
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "-regression-tbl-polling-did-judicial-fair.html")
            )

# Check N & T
summary(plm(as.formula(paste0(dv, "~", iv)),
                        data = p.df
                        , effect = "twoway",
                        model = "within"
           ))
```

```{r}
### WITH judicial_unfair
dv <- c("avg_DEMvote_perc", "avg_REPvote_perc", "log(vep_turnout_rate)")
iv_main <- "interaction_judiciary_unfair"
iv <- paste0(iv_main, " + ", iv_control)
dv_label <- c("DEM candidate's % of county votes (log)", "REP candidate's % of county votes (log)", "Voting-Eligible-Population turnout rate (log)")
# cov_label <- c("Treatment/Control Group (1/0) - Map Drawn by Court", 
#                "Time Period After/Before (1/0)",
#                "Interaction (Judicial x Time)",
#                "Voting-Eligible-Population turnout rate (log)", 
#                "Unemployment rate  (log)",
#                "GDP (log)"
#                #, "State legislature control - DEM", 
#                #"State legislature control - REP"
#                )

# Title = Effect of Redistricting on Party Choice in Presidential Elections
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "-regression-tbl-polling-did-judicial-unfair.html")
            )

# Check N & T
summary(plm(as.formula(paste0(dv, "~", iv)),
                        data = p.df
                        , effect = "twoway",
                        model = "within"
           ))
```

# Arthur Testing Ground

Notes:
* Must exclude crime rate (2020 values do not exist, resulting in an unbalanced panel)
* Narrowing down to 2004 to 2016 does not improve findings (still null and negative adjusted R2)
* Having state-fixed effect with plm() and then manually adding year controls gives differing adjusted R2 values, why? Latter being much higher R2 & adjusted R2

Treatments with findings!
* Did the judiciary find the map to be fair?
* Was there judicial involvement of any kind after redistricting?

```{r arthur testing ground}

### Judiciary involvement (fair map) in redistricting (time and state fixed effects)
dv <- c("avg_DEMvote_perc", "avg_REPvote_perc", "log(vep_turnout_rate)")
dv_label <- c("DEM candidate's % of county votes (log)", "REP candidate's % of county votes (log)", "Voting-Eligible-Population turnout rate (log)")

iv <- "interaction_judiciary_fair + log(vep_density) + log(violent_crime) + log(state_unemploymentRate) + stateparty_control + as.factor(year)"

# Using time and state fixed effect (twoways) under PLM
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, cov_label.sav = NULL, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "/reg-tbl-did-judicial_fair (twoway).html")
            )

# Using state fixed effect (individual) under PLM, but manually adding time control variables
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, cov_label.sav = NULL, 
            title.sav = "",
            effect.sav = "individual",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "/reg-tbl-did-judicial_fair (manual).html")
            )


################################################################################
### Judiciary involvement (unfair map) in redistricting (time and state fixed effects)
iv <- "interaction_judiciary_unfair + log(vep_density) + log(violent_crime) + log(state_unemploymentRate) + stateparty_control + as.factor(year)"

# Using time and state fixed effect (twoways) under PLM
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, cov_label.sav = NULL, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "/reg-tbl-did-judicial_unfair (twoway).html")
            )

# Using state fixed effect (individual) under PLM, but manually adding time control variables
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, cov_label.sav = NULL, 
            title.sav = "",
            effect.sav = "individual",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "/reg-tbl-did-judicial_unfair (manual).html")
            )

################################################################################
### Judiciary involvement (ANY) in redistricting (time and state fixed effects)
iv <- "interaction_judiciary + log(vep_density) + log(violent_crime) + log(state_unemploymentRate) + stateparty_control + as.factor(year)"

# Using time and state fixed effect (twoways) under PLM
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, cov_label.sav = NULL, 
            title.sav = "",
            effect.sav = "twoways",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "/reg-tbl-did-judicial_ANY (twoway).html")
            )

# Using state fixed effect (individual) under PLM, but manually adding time control variables
f.reg.multi(dv.sav = dv, iv.sav = iv, 
            dv_label.sav = dv_label, cov_label.sav = NULL, 
            title.sav = "",
            effect.sav = "individual",
            type.sav = "within"
            , star.type = "html",
            star.out = paste0("05. Visualizations/", today(), "/reg-tbl-did-judicial_ANY (manual).html")
            )

```

```{r multi IV testing}
dv <- "log(vep_turnout_rate)"
iv <- c("interaction_judiciary", "interaction_court_action_none_count", "interaction_judiciary_unfair", "interaction_court_challenge_rejected_count", "interaction_judiciary_fair")
ctrl <- "log(vep_density) + log(state_unemploymentRate) + stateparty_control + log(lagged_vep) + log(vote_closeness)"

f.reg.multi.iv(dv.sav = dv, 
               iv.sav = iv, 
               ctrl.sav = ctrl,
               dataframe.sav = p.df, 
               title.sav = "testingasdf", 
               effect.sav = "twoways",
               type.sav = "within", 
               dv_label.sav = NULL, cov_label.sav = NULL,
               star.type = ifelse(knitr::is_latex_output(),"latex", "text"),
               star.out = NULL)

```

```{r t-test}
t.df <- df %>% 
  filter(avg_DEMvote_perc > 0.0001 & avg_REPvote_perc > 0.0001) %>% 
  # filter(year_num >= 2004 & year_num <= 2016) %>% 
  mutate(time = case_when(year %in% c("2000", "2004", "2008") ~ 0,
                          year %in% c("2012", "2016", "2020") ~ 1)) %>% 
  mutate(stateparty_control = fct_relevel(stateparty_control, "SPLIT", "DEM", "REP")) %>% 
  mutate(interaction_judiciary = time * judiciary_VAR,
         interaction_court_action_none_count = time * court_action_none_count_VAR,
         interaction_court_map_drawn_count = time * court_map_drawn_count_VAR,
         interaction_court_return_leg_count = time * court_return_leg_count_VAR,
         interaction_court_challenge_rejected_count = time * court_challenge_rejected_count_VAR,
         interaction_judiciary_unfair = time * judiciary_unfair_map_VAR,
         interaction_judiciary_fair = time * judiciary_fair_map_VAR
         )

t_test_results <- t.df %>%
  mutate(vep_turnout_change = log(vep_turnout_rate)-log(lagged_vep)) %>%
  group_by(year) %>%
  summarize(p_value = t.test(vep_turnout_change ~ judiciary_VAR, var.equal = FALSE)$p.value, 
            estimate_control = t.test(vep_turnout_change ~ judiciary_VAR, var.equal = FALSE)$estimate["mean in group 0"],
            estimate_treatment = t.test(vep_turnout_change ~ judiciary_VAR, var.equal = FALSE)$estimate["mean in group 1"],
            stderr = t.test(vep_turnout_rate ~ judiciary_VAR, var.equal = FALSE)$stderr)

t_test_results$diff <- t_test_results$estimate_treatment - t_test_results$estimate_control
t_test_results$cimin <- t_test_results$diff + t_test_results$stderr
t_test_results$cimax <- t_test_results$diff - t_test_results$stderr


ggplot(t_test_results, aes(x = as.numeric(year), y = diff)) +
  geom_point() +
  geom_vline(xintercept = 2010, linetype = 2, alpha = 0.4) +
  geom_hline(yintercept = 0, linetype = 1, alpha = 0.7, colour = "red") +
  geom_line() +
  geom_errorbar(aes(ymin = cimin, ymax = cimax), width = 0.2) +
  scale_y_continuous(limits = c(-2, 2), breaks = c(-1,0,1))+
  #scale_x_discrete(limits = c(-5,-4,-3,-2,-1,0,1,2,3,4,5)) +
  labs(x = "Year", y = "Difference in Means (Turnout Rate)",
       title = "Redistriction : T-Test Difference in Means") + 
  theme_minimal()


```
